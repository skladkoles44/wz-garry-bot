#!/bin/sh
LOG="/root/wz-garry-bot/.husky.log"
TS() { date -Iseconds; }

echo "[$(TS)] pre-commit START by $(git config user.name) <$(git config user.email)>" >> "$LOG"

echo "ðŸ” Husky pre-commit started..."

# Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð¸Ð½Ð´ÐµÐºÑÐµ, ÐºÑ€Ð¾Ð¼Ðµ markdown
STAGED_NON_MD=$(git diff --cached --name-only | grep -Ev '\.md$' || true)

# ðŸ”’ Ð·Ð°Ð¿Ñ€ÐµÑ‚ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
if echo "$STAGED_NON_MD" | grep -Eq '(\.env|\.enc|keys\.txt)'; then
  echo "ðŸš« ERROR: Ð½ÐµÐ»ÑŒÐ·Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ÑŒ .env, .enc Ð¸Ð»Ð¸ ÐºÐ»ÑŽÑ‡Ð¸!"
  echo "[$(TS)] BLOCK: secret filename" >> "$LOG"
  echo "[$(TS)] pre-commit END (FAIL)" >> "$LOG"
  exit 1
fi

# ðŸš¨ Ð¿Ð¾Ð¸ÑÐº Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð² â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð½Ðµ-Markdown Ñ„Ð°Ð¹Ð»Ð°Ñ…
if [ -n "$STAGED_NON_MD" ] && git diff --cached -- $STAGED_NON_MD | grep -E '(^|[[:space:]])TOKEN=' >/dev/null; then
  echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼."
  echo "[$(TS)] BLOCK: token pattern in non-md" >> "$LOG"
  echo "[$(TS)] pre-commit END (FAIL)" >> "$LOG"
  exit 1
fi

# ðŸ§¹ ESLint
if npx eslint . --ext .js >> "$LOG" 2>&1; then
  echo "[$(TS)] ESLint OK" >> "$LOG"
else
  echo "[$(TS)] ESLint FAIL" >> "$LOG"
  echo "âŒ ESLint failed"
  echo "[$(TS)] pre-commit END (FAIL)" >> "$LOG"
  exit 1
fi

# ðŸ§ª Ð¢ÐµÑÑ‚Ñ‹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
if npm test >> "$LOG" 2>&1; then
  echo "[$(TS)] Tests OK" >> "$LOG"
else
  echo "[$(TS)] Tests skipped or failed (non-blocking)" >> "$LOG"
  echo "â„¹ï¸ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ñ‹ (Ð½ÐµÑ‚ Ñ„Ð°Ð¹Ð»Ð° test)"
fi

echo "âœ… Husky checks passed."
echo "[$(TS)] pre-commit END (OK)" >> "$LOG"
